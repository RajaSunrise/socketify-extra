name: Windows Build

on: workflow_dispatch

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build on windows-amd64
    steps:
      - uses: ilammy/msvc-dev-cmd@v1
      - uses: ilammy/setup-nasm@v1.2.1
      - name: Update binaries
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          $Env:CC='clang'
          $Env:CXX='clang++'
          # Clone the repository
          git clone --recursive https://github.com/RajaSunrise/socketify-extra.git socketify-extra
          cd socketify-extra
          # Build uWebSockets (assuming it has a CMakeLists.txt)
          cd uWebSockets
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -GNinja
          ninja
          cd ../../
          # Build libsocketify
          cd socketify_extra\native
          vcpkg install libuv:x64-windows-static-md
          vcpkg integrate install
          # Assuming you have a Makefile in socketify_extra/native
          make windows-release-libuv-static # Adjust to your Makefile target
          # Update the git repository
          cd ..
          git add libsocketify_windows_amd64.dll
          git config --global user.email "indra020204@gmail.com"
          git config --global user.name "RajaSunrise"
          git commit -m "[GitHub Actions] Updated windows-amd64 binaries"
          git push -f "https://RajaSunrise:${{ secrets.BUILDTOKEN }}@github.com/RajaSunrise/socketify-extra.git"
